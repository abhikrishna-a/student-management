{% extends 'base.html' %}

{% block title %}Purchase Courses - Student Management System{% endblock %}

{% block extra_css %}
<style>
    .course-checkbox {
        width: 1.25rem;
        height: 1.25rem;
        border-radius: 0.375rem;
        border: 2px solid #d1d5db;
        appearance: none;
        -webkit-appearance: none;
        background-color: white;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    .course-checkbox:checked {
        background-color: #0f172a;
        border-color: #0f172a;
        background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e");
        background-size: 100% 100%;
        background-position: center;
        background-repeat: no-repeat;
    }
    .course-checkbox:disabled {
        background-color: #9ca3af;
        border-color: #9ca3af;
        cursor: not-allowed;
        opacity: 0.5;
    }
    .course-card {
        transition: all 0.3s ease;
    }
    .course-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
    .search-input:focus {
        border-color: #0f172a;
        box-shadow: 0 0 0 3px rgba(15, 23, 42, 0.1);
    }
    .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    .sticky-footer {
        position: sticky;
        bottom: 0;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-top: 1px solid #e2e8f0;
        box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.1);
        z-index: 40;
    }
</style>
{% endblock %}

{% block page_title %}Purchase Courses{% endblock %}
{% block page_subtitle %}Select courses to enhance your learning journey{% endblock %}

{% block content %}

{% if messages %}
    {% for message in messages %}
        <div class="mb-4 px-4 py-3 rounded-lg text-sm font-medium
            {% if message.tags == 'error' %} bg-red-50 text-red-700 border border-red-200
            {% else %} bg-green-50 text-green-700 border border-green-200 {% endif %}">
            <i class="bi {% if message.tags == 'error' %}bi-exclamation-circle{% else %}bi-check-circle{% endif %} me-2"></i>
            {{ message }}
        </div>
    {% endfor %}
{% endif %}

<!-- Search and Stats -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
    <div class="lg:col-span-2">
        <div class="relative">
            <div class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400">
                <i class="bi bi-search text-xl"></i>
            </div>
            <input type="text"
                class="search-input w-full pl-12 pr-4 py-3 bg-white border-2 border-slate-200 rounded-xl text-base placeholder-slate-400 focus:outline-none focus:border-slate-900 focus:ring-2 focus:ring-slate-900/10 transition-all"
                id="course_search" placeholder="Search courses by name or ID...">
        </div>
    </div>

    <div class="grid grid-cols-3 gap-4">
        <div class="bg-white rounded-xl shadow-sm p-4 text-center border-l-4 border-slate-900">
            <p class="text-slate-500 text-sm font-medium mb-1">Selected</p>
            <h3 class="text-2xl font-bold text-slate-900" id="selected_count">0</h3>
        </div>
        <div class="bg-white rounded-xl shadow-sm p-4 text-center border-l-4 border-emerald-500">
            <p class="text-slate-500 text-sm font-medium mb-1">Total</p>
            <h3 class="text-2xl font-bold text-emerald-600" id="total_price">₹0</h3>
        </div>
        <div class="bg-white rounded-xl shadow-sm p-4 text-center border-l-4 border-purple-500">
            <p class="text-slate-500 text-sm font-medium mb-1">Courses</p>
            <h3 class="text-2xl font-bold text-purple-600" id="total_courses">{{ total_courses }}</h3>
        </div>
    </div>
</div>

<!-- Courses List -->
<div class="space-y-4" id="courses_grid">

    {% for item in courses_with_status %}
    {% with course=item.course status=item.status %}

    <div class="course-card {% if status %}opacity-80{% endif %}"
         data-course-name="{{ course.course_name|lower }}"
         data-course-id="{{ course.course_id|default:'' }}">

        <div class="bg-white rounded-xl shadow-md overflow-hidden border-2
            {% if status %}border-slate-300 bg-slate-50{% else %}border-slate-200 hover:border-slate-400{% endif %} transition-all">
            <div class="p-6">
                <div class="flex items-start gap-4">

                    <!-- Checkbox -->
                    <div class="flex-shrink-0">
                        <input class="course-checkbox" type="checkbox"
                               value="{{ course.pk }}"
                               id="course_{{ course.pk }}"
                               data-price="{{ course.course_price }}"
                               {% if status %}disabled checked{% endif %}>
                    </div>

                    <!-- Course Info -->
                    <div class="flex-1 min-w-0">
                        <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between">
                            <div class="mb-3 sm:mb-0">
                                <div class="flex items-center flex-wrap gap-2 mb-2">
                                    <h3 class="text-xl font-bold text-slate-900">
                                        {{ course.course_name }}
                                    </h3>
                                    {% if course.course_id %}
                                    <span class="inline-block px-2 py-1 bg-slate-100 text-slate-800 text-xs font-semibold rounded-md">
                                        {{ course.course_id }}
                                    </span>
                                    {% endif %}
                                </div>
                                <div class="flex items-center text-slate-600 mb-2">
                                    <i class="bi bi-building mr-2"></i>
                                    <span class="text-sm">{{ course.department|default:"General" }}</span>
                                </div>
                                <p class="text-slate-600 text-sm line-clamp-2">
                                    {{ course.course_description|default:"No description available." }}
                                </p>
                            </div>

                            <!-- Price + Status -->
                            <div class="flex flex-col items-end gap-2">
                                <div class="text-2xl font-bold text-emerald-600">
                                    {{ course.formatted_price }}
                                </div>

                                {% if status == 'APPROVED' %}
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800 border border-green-200">
                                        <i class="bi bi-check-circle mr-1 text-xs"></i> Approved
                                    </span>
                                {% elif status == 'PENDING' %}
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800 border border-yellow-200">
                                        <i class="bi bi-clock mr-1 text-xs"></i> Pending Approval
                                    </span>
                                {% elif status == 'REJECTED' %}
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-red-100 text-red-800 border border-red-200">
                                        <i class="bi bi-x-circle mr-1 text-xs"></i> Rejected
                                    </span>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    {% endwith %}
    {% empty %}
    <div class="text-center py-16 text-slate-500">
        <i class="bi bi-journal-x text-5xl mb-4 block"></i>
        <p class="text-lg font-medium">No courses available yet.</p>
        <p class="text-sm">Check back later or contact your administrator.</p>
    </div>
    {% endfor %}

</div>

<!-- Action Footer -->
<div class="sticky-footer -mx-4 sm:-mx-6 lg:-mx-8 px-4 sm:px-6 lg:px-8 py-4 mt-8">
    <div class="max-w-7xl mx-auto">
        <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
            <div>
                <h4 class="text-lg font-semibold text-slate-900">
                    <span id="footer_selected_count">0</span> course(s) selected
                </h4>
                <p class="text-slate-600">
                    Total amount: <span class="font-bold text-emerald-600" id="footer_total_price">₹0</span>
                </p>
            </div>
            <div class="flex gap-3">
                <button onclick="clearSelection()" class="px-6 py-3 bg-slate-100 text-slate-700 font-semibold rounded-lg hover:bg-slate-200 transition-colors flex items-center">
                    <i class="bi bi-x-circle mr-2"></i>
                    Clear Selection
                </button>
                <form method="POST" action="" id="bulkPurchaseForm" class="inline">
                    {% csrf_token %}
                    <input type="hidden" name="course_ids" id="selected_course_ids">
                    <button type="submit" id="purchaseBtn" disabled
                        class="px-6 py-3 bg-slate-900 text-white font-semibold rounded-lg hover:bg-slate-800 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center">
                        <i class="bi bi-cart mr-2"></i>
                        <span id="purchaseBtnText">Request Purchase</span>
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="h-24"></div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const totalCourses = document.querySelectorAll('.course-card').length;
        document.getElementById('total_courses').textContent = totalCourses;

        document.querySelectorAll('.course-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', updateTotals);
        });
        updateTotals();

        document.querySelectorAll('.course-card:not(.opacity-80)').forEach(card => {
            card.addEventListener('click', function (e) {
                if (e.target.type === 'checkbox' || e.target.tagName === 'BUTTON' || e.target.closest('button') || e.target.closest('form')) return;
                const checkbox = this.querySelector('.course-checkbox');
                if (checkbox && !checkbox.disabled) {
                    checkbox.checked = !checkbox.checked;
                    checkbox.dispatchEvent(new Event('change'));
                }
            });
        });
    });

    function filterCourses() {
        const searchTerm = document.getElementById('course_search').value.toLowerCase();
        document.querySelectorAll('.course-card').forEach(card => {
            const courseName = card.getAttribute('data-course-name') || '';
            const courseId = card.getAttribute('data-course-id') || '';
            card.style.display = (courseName.includes(searchTerm) || courseId.toLowerCase().includes(searchTerm)) ? '' : 'none';
        });
    }

    function updateTotals() {
        let totalPrice = 0;
        let selectedCount = 0;
        let selectedIds = [];

        document.querySelectorAll('.course-checkbox:checked:not(:disabled)').forEach(checkbox => {
            selectedCount++;
            totalPrice += parseInt(checkbox.getAttribute('data-price') || 0);
            selectedIds.push(checkbox.value);
        });

        document.getElementById('selected_count').textContent = selectedCount;
        document.getElementById('footer_selected_count').textContent = selectedCount;
        document.getElementById('total_price').textContent = '₹' + totalPrice.toLocaleString('en-IN');
        document.getElementById('footer_total_price').textContent = '₹' + totalPrice.toLocaleString('en-IN');

        const purchaseBtn = document.getElementById('purchaseBtn');
        const purchaseBtnText = document.getElementById('purchaseBtnText');
        const selectedIdsInput = document.getElementById('selected_course_ids');

        purchaseBtn.disabled = selectedCount === 0;
        purchaseBtnText.textContent = selectedCount > 0 ? `Request Purchase (${selectedCount})` : 'Request Purchase';
        if (selectedIdsInput) selectedIdsInput.value = selectedIds.join(',');
    }

    function clearSelection() {
        document.querySelectorAll('.course-checkbox:checked:not(:disabled)').forEach(cb => cb.checked = false);
        updateTotals();
    }

    document.getElementById('course_search').addEventListener('keyup', filterCourses);
</script>
{% endblock %}